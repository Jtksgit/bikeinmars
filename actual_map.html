<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  html, body { margin: 0; height: 100%; }
  #map { width: 100%; height: 100%; }
  .station-tooltip {
    background: transparent;
    border: none !important;
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    pointer-events: none;
  }
</style>
</head>
<body>
<div id="map"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ----------------------------
// CONFIGURATION SUPABASE
// ----------------------------
const supabaseUrl = 'https://YOUR_PROJECT_REF.supabase.co';
const supabaseKey = 'YOUR_PUBLIC_ANON_KEY';
const supabase = createClient(supabaseUrl, supabaseKey);

// Carte Leaflet
const map = L.map("map").setView([43.3, 5.38], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

// ----------------------------
// Fonction pour afficher la carte
// ----------------------------
async function loadMapData() {
  try {
    // 1️⃣ Récupérer toutes les stations
    const { data: stations, error: stationsError } = await supabase
      .from('station_info')
      .select('*');

    if (stationsError) return console.error('Erreur stations:', stationsError);

    // 2️⃣ Récupérer les vélos récents
    const { data: bikes, error: bikesError } = await supabase
      .from('bike_data')
      .select('*');

    if (bikesError) return console.error('Erreur vélos:', bikesError);

    // Créer un layer group pour stations
    const stationLayer = L.layerGroup().addTo(map);

    stations.forEach(st => {
      // Vélos à cette station
      const bikesHere = bikes.filter(b => b.station_id === st.station_id);
      const nbVelo = bikesHere.length;

      let popup = `<b>${st.name}</b><br>🚲 ${nbVelo} vélos disponibles`;

      if (nbVelo > 0) {
        popup += "<br><ul>";
        bikesHere.forEach(b => {
          popup += `<li>${b.bike_id} 🔋 ${b.battery}%</li>`;
        });
        popup += "</ul>";
      }

      const circle = L.circleMarker([st.lat, st.lon], {
        radius: 12,
        color: '#E94E1B',
        fillColor: '#E94E1B',
        fillOpacity: 0.8,
        weight: 0
      }).addTo(stationLayer);

      circle.bindPopup(popup);
      circle.bindTooltip(`${nbVelo}`, {
        permanent: true,
        direction: 'center',
        className: 'station-tooltip'
      }).openTooltip();
    });

  } catch (err) {
    console.error('Erreur loadMapData:', err);
  }
}

// Refresh toutes les 1 min
loadMapData();
setInterval(loadMapData, 60_000);
</script>
</body>
</html>
