<!DOCTYPE html>

<html lang="fr">

<head>

<meta charset="UTF-8">

<title>Stations de vélos Marseille</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>



<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>



<style>

  html, body {

    margin: 0;

    height: 100%;

  }

  #map {

    width: 100%;

    height: 100%;

  }



  /* Styles pour le nouveau contrôle Leaflet */

  .leaflet-control-log {

    background: rgba(255, 255, 255, 0.9);

    padding: 6px 10px;

    border-radius: 5px;

    font-size: 12px;

    box-shadow: 0 0 5px rgba(0,0,0,0.3);

    pointer-events: none;

    margin: 10px;

    z-index: 1000;

  }

</style>

</head>

<body>

  <div id="map"></div>

  <script>

    // -----------------------------

    // Proxy CORS et URLs API

    // -----------------------------

    const cors = "https://corsproxy.io/?";

    const url_info = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/station_information.json");

    const url_status = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/station_status.json");

    const url_bikes = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/free_bike_status.json");



    // -----------------------------

    // Carte Leaflet

    // -----------------------------

    const map = L.map("map").setView([43.3, 5.38], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {

      attribution: "&copy; OpenStreetMap contributors"

    }).addTo(map);



    // Contrôle pour la géolocalisation

    L.control.locate({

      position: "topleft",

      strings: { title: "Ma position" },

      flyTo: true, // Se déplace vers la position de l'utilisateur

      locateOptions: { enableHighAccuracy: true }

    }).addTo(map);



    // -----------------------------

    // Contrôle Leaflet personnalisé pour l'overlay

    // -----------------------------

    const LogControl = L.Control.extend({

      onAdd: function(map) {

        const div = L.DomUtil.create('div', 'leaflet-control-log');

        div.innerHTML = "Chargement...";

        L.DomEvent.disableClickPropagation(div);

        return div;

      },

    });

    new LogControl({ position: 'bottomleft' }).addTo(map);



    // -----------------------------

    // Chargement et affichage des données

    // -----------------------------

    async function loadData() {

      const logOverlay = document.querySelector('.leaflet-control-log');

      if (logOverlay) {

        logOverlay.innerHTML = "⏳ Mise à jour en cours...";

      }



      try {

        const [infoRes, statusRes, bikesRes] = await Promise.all([

          fetch(url_info).then(r => r.json()),

          fetch(url_status).then(r => r.json()),

          fetch(url_bikes).then(r => r.json())

        ]);



        const info = infoRes.data.stations;

        const status = statusRes.data.stations;

        const bikes = bikesRes.data.bikes;



        const stations = {};

        info.forEach(s => {

          stations[s.station_id] = { name: s.name, lat: s.lat, lon: s.lon, bikes: 0, docks: 0 };

        });

        status.forEach(s => {

          if (stations[s.station_id]) {

            stations[s.station_id].bikes = s.num_bikes_available;

            stations[s.station_id].docks = s.num_docks_available;

          }

        });



        const bikesByStation = {};

        const MAX_RANGE = 45000;

        bikes.forEach(b => {

          if (b.station_id) {

            const percent = Math.round((b.current_range_meters / MAX_RANGE) * 100);

            const link = `https://www.levelo.fr/app/bike/${b.bike_id}`;

            const text = `Vélo - 🔋 ${percent}%`;// <br><a href="${link}" target="_blank">Ouvrir</a>`;

            if (!bikesByStation[b.station_id]) bikesByStation[b.station_id] = [];

            bikesByStation[b.station_id].push(text);

          }

        });



        if (window.stationLayer) map.removeLayer(window.stationLayer);

        window.stationLayer = L.layerGroup().addTo(map);



        Object.entries(stations).forEach(([id, st]) => {

          let popup = `<b>${st.name}</b><br>🚲 ${st.bikes} vélos<br>🅿️ ${st.docks} places`;

          if (bikesByStation[id]) popup += "<br><br> bikesByStation[id].join("<br>");

          L.marker([st.lat, st.lon]).addTo(window.stationLayer).bindPopup(popup);

        });



        if (logOverlay) {

          logOverlay.innerHTML = "✅ Dernière mise à jour : " + new Date().toLocaleTimeString();

        }

      } catch (err) {

        if (logOverlay) {

          logOverlay.innerHTML = "❌ Erreur : " + err;

        }

        console.error(err);

      }

    }



    // -----------------------------

    // Refresh toutes les 2 minutes

    // -----------------------------

    function refresh() {

      loadData();

      setTimeout(refresh, 120000);

    }

    refresh();

  </script>

</body>

</html>
