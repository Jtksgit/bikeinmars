<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Stations de v√©los Marseille</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<style>
  html, body { margin: 0; height: 100%; }
  #map { width: 100%; height: 100%; }

  /* Styles pour le contr√¥le log */
  .leaflet-control-log {
    background: rgba(255, 255, 255, 0.9);
    padding: 6px 10px;
    border-radius: 5px;
    font-size: 12px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    pointer-events: none;
    margin: 10px;
    z-index: 1000;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
  // -----------------------------
  // Proxy CORS et URLs API
  // -----------------------------
  const cors = "https://corsproxy.io/?";
  const url_info = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/station_information.json");
  const url_status = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/station_status.json");
  const url_bikes = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/free_bike_status.json");

  // -----------------------------
  // Carte Leaflet
  // -----------------------------
  const map = L.map("map").setView([43.3, 5.38], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // G√©olocalisation
  L.control.locate({
    position: "topleft",
    strings: { title: "Ma position" },
    flyTo: true,
    locateOptions: { enableHighAccuracy: true }
  }).addTo(map);

  // -----------------------------
  // Contr√¥le log
  // -----------------------------
  const LogControl = L.Control.extend({
    onAdd: function(map) {
      const div = L.DomUtil.create('div', 'leaflet-control-log');
      div.innerHTML = "Chargement...";
      L.DomEvent.disableClickPropagation(div);
      return div;
    },
  });
  const logControl = new LogControl({ position: 'bottomleft' }).addTo(map);

  // -----------------------------
  // Chargement des donn√©es
  // -----------------------------
  async function loadData() {
    const logOverlay = document.querySelector('.leaflet-control-log');
    if (logOverlay) logOverlay.innerHTML = "‚è≥ Mise √† jour en cours...";

    try {
      const [infoRes, statusRes, bikesRes] = await Promise.all([
        fetch(url_info).then(r => r.json()),
        fetch(url_status).then(r => r.json()),
        fetch(url_bikes).then(r => r.json())
      ]);

      const info = infoRes.data.stations;
      const status = statusRes.data.stations;
      const bikes = bikesRes.data.bikes;

      // Fusion infos + statut
      const stations = {};
      info.forEach(s => {
        stations[s.station_id] = { name: s.name, lat: s.lat, lon: s.lon, bikes: 0, docks: 0 };
      });
      status.forEach(s => {
        if (stations[s.station_id]) {
          stations[s.station_id].bikes = s.num_bikes_available;
          stations[s.station_id].docks = s.num_docks_available;
        }
      });

      // V√©los par station
      const bikesByStation = {};
      const MAX_RANGE = 45000;
      bikes.forEach(b => {
        if (b.station_id) {
          const percent = Math.round((b.current_range_meters / MAX_RANGE) * 100);
          const text = `V√©lo - üîã ${percent}%`;
          if (!bikesByStation[b.station_id]) bikesByStation[b.station_id] = [];
          bikesByStation[b.station_id].push(text);
        }
      });

      // Supprimer anciens marqueurs
      if (window.stationLayer) map.removeLayer(window.stationLayer);
      window.stationLayer = L.layerGroup().addTo(map);

      // Ajouter stations avec popup
      Object.entries(stations).forEach(([id, st]) => {
        const nbVelo = st.bikes;
        const popup = `<b>${st.name}</b><br>üö≤ ${nbVelo} v√©los<br>üÖøÔ∏è ${st.docks} places`;
      
        // Cercle de taille fixe
        const circle = L.circleMarker([st.lat, st.lon], {
          radius: 15,           // taille fixe
          color: 'blue',
          fillColor: 'blue',
          fillOpacity: 0.5,
          weight: 1
        }).addTo(window.stationLayer);
      
        // Popup classique
        circle.bindPopup(popup);
      
        // Tooltip permanent pour afficher le nombre de v√©los
        circle.bindTooltip(`${nbVelo}`, {
          permanent: true,
          direction: 'center',
          className: 'station-tooltip'
        }).openTooltip();
      });
      .station-tooltip {
        background: rgba(255,255,255,0.8);
        border-radius: 50%;
        color: black;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        padding: 2px 4px;
        pointer-events: none; /* pour que le tooltip ne bloque pas le clic sur le cercle */
      }


      if (logOverlay) logOverlay.innerHTML = "‚úÖ Derni√®re mise √† jour : " + new Date().toLocaleTimeString();

    } catch (err) {
      if (logOverlay) logOverlay.innerHTML = "‚ùå Erreur : " + err;
      console.error(err);
    }
  }

  // -----------------------------
  // Refresh toutes les 2 minutes
  // -----------------------------
  function refresh() {
    loadData();
    setTimeout(refresh, 120000);
  }
  refresh();

</script>
</body>
</html>
