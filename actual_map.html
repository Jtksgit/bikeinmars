<!DOCTYPE html>

<html lang="fr">

<head>

<meta charset="UTF-8">

<title>Stations de vÃ©los Marseille</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>



<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>



<style>

Â  html, body {

Â  Â  margin: 0;

Â  Â  height: 100%;

Â  }

Â  #map {

Â  Â  width: 100%;

Â  Â  height: 100%;

Â  }



Â  /* Styles pour le nouveau contrÃ´le Leaflet */

Â  .leaflet-control-log {

Â  Â  background: rgba(255, 255, 255, 0.9);

Â  Â  padding: 6px 10px;

Â  Â  border-radius: 5px;

Â  Â  font-size: 12px;

Â  Â  box-shadow: 0 0 5px rgba(0,0,0,0.3);

Â  Â  pointer-events: none;

Â  Â  margin: 10px;

Â  Â  z-index: 1000;

Â  }

</style>

</head>

<body>

Â  <div id="map"></div>

Â  <script>

Â  Â  // -----------------------------

Â  Â  // Proxy CORS et URLs API

Â  Â  // -----------------------------

Â  Â  const cors = "https://corsproxy.io/?";

Â  Â  const url_info = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/station_information.json");

Â  Â  const url_status = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/station_status.json");

Â  Â  const url_bikes = cors + encodeURIComponent("https://gbfs.omega.fifteen.eu/gbfs/2.2/marseille/en/free_bike_status.json");



Â  Â  // -----------------------------

Â  Â  // Carte Leaflet

Â  Â  // -----------------------------

Â  Â  const map = L.map("map").setView([43.3, 5.38], 13);

Â  Â  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {

Â  Â  Â  attribution: "&copy; OpenStreetMap contributors"

Â  Â  }).addTo(map);



Â  Â  // ContrÃ´le pour la gÃ©olocalisation

Â  Â  L.control.locate({

Â  Â  Â  position: "topleft",

Â  Â  Â  strings: { title: "Ma position" },

Â  Â  Â  flyTo: true, // Se dÃ©place vers la position de l'utilisateur

Â  Â  Â  locateOptions: { enableHighAccuracy: true }

Â  Â  }).addTo(map);



Â  Â  // -----------------------------

Â  Â  // ContrÃ´le Leaflet personnalisÃ© pour l'overlay

Â  Â  // -----------------------------

Â  Â  const LogControl = L.Control.extend({

Â  Â  Â  onAdd: function(map) {

Â  Â  Â  Â  const div = L.DomUtil.create('div', 'leaflet-control-log');

Â  Â  Â  Â  div.innerHTML = "Chargement...";

Â  Â  Â  Â  L.DomEvent.disableClickPropagation(div);

Â  Â  Â  Â  return div;

Â  Â  Â  },

Â  Â  });

Â  Â  new LogControl({ position: 'bottomleft' }).addTo(map);



Â  Â  // -----------------------------

Â  Â  // Chargement et affichage des donnÃ©es

Â  Â  // -----------------------------

Â  Â  async function loadData() {

Â  Â  Â  const logOverlay = document.querySelector('.leaflet-control-log');

Â  Â  Â  if (logOverlay) {

Â  Â  Â  Â  logOverlay.innerHTML = "â³ Mise Ã  jour en cours...";

Â  Â  Â  }



Â  Â  Â  try {

Â  Â  Â  Â  const [infoRes, statusRes, bikesRes] = await Promise.all([

Â  Â  Â  Â  Â  fetch(url_info).then(r => r.json()),

Â  Â  Â  Â  Â  fetch(url_status).then(r => r.json()),

Â  Â  Â  Â  Â  fetch(url_bikes).then(r => r.json())

Â  Â  Â  Â  ]);



Â  Â  Â  Â  const info = infoRes.data.stations;

Â  Â  Â  Â  const status = statusRes.data.stations;

Â  Â  Â  Â  const bikes = bikesRes.data.bikes;



Â  Â  Â  Â  const stations = {};

Â  Â  Â  Â  info.forEach(s => {

Â  Â  Â  Â  Â  stations[s.station_id] = { name: s.name, lat: s.lat, lon: s.lon, bikes: 0, docks: 0 };

Â  Â  Â  Â  });

Â  Â  Â  Â  status.forEach(s => {

Â  Â  Â  Â  Â  if (stations[s.station_id]) {

Â  Â  Â  Â  Â  Â  stations[s.station_id].bikes = s.num_bikes_available;

Â  Â  Â  Â  Â  Â  stations[s.station_id].docks = s.num_docks_available;

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });



Â  Â  Â  Â  const bikesByStation = {};

Â  Â  Â  Â  const MAX_RANGE = 45000;

Â  Â  Â  Â  bikes.forEach(b => {

Â  Â  Â  Â  Â  if (b.station_id) {

Â  Â  Â  Â  Â  Â  const percent = Math.round((b.current_range_meters / MAX_RANGE) * 100);

Â  Â  Â  Â  Â  Â  const link = `https://www.levelo.fr/app/bike/${b.bike_id}`;

Â  Â  Â  Â  Â  Â  const text = `VÃ©lo - ğŸ”‹ ${percent}%`;// <br><a href="${link}" target="_blank">Ouvrir</a>`;

Â  Â  Â  Â  Â  Â  if (!bikesByStation[b.station_id]) bikesByStation[b.station_id] = [];

Â  Â  Â  Â  Â  Â  bikesByStation[b.station_id].push(text);

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });



Â  Â  Â  Â  if (window.stationLayer) map.removeLayer(window.stationLayer);

Â  Â  Â  Â  window.stationLayer = L.layerGroup().addTo(map);



Â  Â  Â  Â  Object.entries(stations).forEach(([id, st]) => {

Â  Â  Â  Â  Â  let popup = `<b>${st.name}</b><br>ğŸš² ${st.bikes} vÃ©los<br>ğŸ…¿ï¸ ${st.docks} places`;

Â  Â  Â  Â  Â  if (bikesByStation[id]) popup += "<br><br> bikesByStation[id].join("<br>");

Â  Â  Â  Â  Â  L.marker([st.lat, st.lon]).addTo(window.stationLayer).bindPopup(popup);

Â  Â  Â  Â  });



Â  Â  Â  Â  if (logOverlay) {

Â  Â  Â  Â  Â  logOverlay.innerHTML = "âœ… DerniÃ¨re mise Ã  jour : " + new Date().toLocaleTimeString();

Â  Â  Â  Â  }

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  if (logOverlay) {

Â  Â  Â  Â  Â  logOverlay.innerHTML = "âŒ Erreur : " + err;

Â  Â  Â  Â  }

Â  Â  Â  Â  console.error(err);

Â  Â  Â  }

Â  Â  }



Â  Â  // -----------------------------

Â  Â  // Refresh toutes les 2 minutes

Â  Â  // -----------------------------

Â  Â  function refresh() {

Â  Â  Â  loadData();

Â  Â  Â  setTimeout(refresh, 120000);

Â  Â  }

Â  Â  refresh();

Â  </script>

</body>

</html>
